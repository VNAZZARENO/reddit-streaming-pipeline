<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Market Sentiment Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #1a1a1a;
            color: #ffffff;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background-color: #2d2d2d;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .card h3 {
            color: #00d4ff;
            margin-top: 0;
            border-bottom: 2px solid #00d4ff;
            padding-bottom: 10px;
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }
        .comments-section {
            grid-column: span 2;
        }
        .comment-item {
            background-color: #3a3a3a;
            margin: 10px 0;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #00d4ff;
        }
        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.9em;
            color: #cccccc;
        }
        .tickers {
            display: flex;
            gap: 8px;
            margin: 8px 0;
        }
        .ticker-badge {
            background-color: #00d4ff;
            color: #000;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }
        .sentiment {
            font-weight: bold;
        }
        .sentiment.positive { color: #4caf50; }
        .sentiment.negative { color: #f44336; }
        .sentiment.neutral { color: #ff9800; }
        .refresh-btn {
            background-color: #00d4ff;
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .refresh-btn:hover {
            background-color: #0099cc;
        }
        .no-data {
            text-align: center;
            color: #888;
            font-style: italic;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸš€ Stock Market Sentiment Dashboard</h1>
        <p>Real-time sentiment analysis from Reddit financial communities</p>
        <button class="refresh-btn" onclick="refreshDashboard()">ðŸ”„ Refresh Data</button>
    </div>

    <div class="dashboard-grid">
        <div class="card">
            <h3>ðŸ“Š Financial Subreddits Sentiment</h3>
            <div class="chart-container">
                <canvas id="subredditChart"></canvas>
            </div>
        </div>

        <div class="card">
            <h3>ðŸ’° Top Stock Tickers Sentiment</h3>
            <div class="chart-container">
                <canvas id="tickerChart"></canvas>
            </div>
        </div>

        <div class="card comments-section">
            <h3>ðŸ’¬ Recent Comments with Stock Mentions</h3>
            <div id="commentsContainer">
                <div class="no-data">Loading comments...</div>
            </div>
        </div>
    </div>

    <script>
        let subredditChart, tickerChart;

        function initCharts() {
            // Subreddit Chart
            const subredditCtx = document.getElementById('subredditChart').getContext('2d');
            subredditChart = new Chart(subredditCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#ffffff' } }
                    },
                    scales: {
                        x: { ticks: { color: '#ffffff' } },
                        y: { 
                            ticks: { color: '#ffffff' },
                            title: {
                                display: true,
                                text: 'Sentiment Score',
                                color: '#ffffff'
                            }
                        }
                    }
                }
            });

            // Ticker Chart
            const tickerCtx = document.getElementById('tickerChart').getContext('2d');
            tickerChart = new Chart(tickerCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Average Sentiment',
                        data: [],
                        backgroundColor: '#00d4ff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#ffffff' } }
                    },
                    scales: {
                        x: { ticks: { color: '#ffffff' } },
                        y: { 
                            ticks: { color: '#ffffff' },
                            title: {
                                display: true,
                                text: 'Sentiment Score',
                                color: '#ffffff'
                            },
                            min: -1,
                            max: 1
                        }
                    }
                }
            });
        }

        async function loadSubredditData() {
            try {
                const response = await fetch('/api/subreddit_sentiment');
                const data = await response.json();
                
                if (data.length === 0) {
                    console.log('No subreddit data available');
                    return;
                }

                // Group by subreddit
                const grouped = {};
                data.forEach(item => {
                    if (!grouped[item.subreddit]) {
                        grouped[item.subreddit] = [];
                    }
                    grouped[item.subreddit].push({
                        x: new Date(item.timestamp),
                        y: item.sentiment
                    });
                });

                // Update chart
                subredditChart.data.datasets = Object.keys(grouped).map((subreddit, index) => ({
                    label: `r/${subreddit}`,
                    data: grouped[subreddit],
                    borderColor: `hsl(${index * 60}, 70%, 60%)`,
                    backgroundColor: `hsla(${index * 60}, 70%, 60%, 0.1)`,
                    fill: false
                }));

                subredditChart.update();
            } catch (error) {
                console.error('Error loading subreddit data:', error);
            }
        }

        async function loadTickerData() {
            try {
                const response = await fetch('/api/ticker_sentiment');
                const data = await response.json();
                
                if (data.length === 0) {
                    console.log('No ticker data available');
                    return;
                }

                // Calculate average sentiment per ticker
                const tickerAvg = {};
                data.forEach(item => {
                    if (!tickerAvg[item.ticker]) {
                        tickerAvg[item.ticker] = { total: 0, count: 0 };
                    }
                    tickerAvg[item.ticker].total += item.sentiment;
                    tickerAvg[item.ticker].count += 1;
                });

                // Get top 10 tickers by mention count
                const sortedTickers = Object.entries(tickerAvg)
                    .map(([ticker, data]) => ({
                        ticker,
                        sentiment: data.total / data.count,
                        mentions: data.count
                    }))
                    .sort((a, b) => b.mentions - a.mentions)
                    .slice(0, 10);

                // Update chart
                tickerChart.data.labels = sortedTickers.map(item => item.ticker);
                tickerChart.data.datasets[0].data = sortedTickers.map(item => item.sentiment);
                tickerChart.data.datasets[0].backgroundColor = sortedTickers.map(item => 
                    item.sentiment > 0.1 ? '#4caf50' : 
                    item.sentiment < -0.1 ? '#f44336' : '#ff9800'
                );
                tickerChart.update();
            } catch (error) {
                console.error('Error loading ticker data:', error);
            }
        }

        async function loadComments() {
            try {
                const response = await fetch('/api/recent_comments');
                const data = await response.json();
                
                const container = document.getElementById('commentsContainer');
                
                if (data.length === 0) {
                    container.innerHTML = '<div class="no-data">No recent comments available. Waiting for Reddit API access...</div>';
                    return;
                }

                container.innerHTML = data.map(comment => {
                    const sentimentClass = comment.sentiment > 0.1 ? 'positive' : 
                                         comment.sentiment < -0.1 ? 'negative' : 'neutral';
                    const sentimentText = comment.sentiment > 0.1 ? 'Positive' : 
                                        comment.sentiment < -0.1 ? 'Negative' : 'Neutral';
                    
                    return `
                        <div class="comment-item">
                            <div class="comment-header">
                                <span><strong>r/${comment.subreddit}</strong></span>
                                <span class="sentiment ${sentimentClass}">${sentimentText} (${comment.sentiment.toFixed(3)})</span>
                            </div>
                            <div class="tickers">
                                ${comment.tickers.map(ticker => `<span class="ticker-badge">$${ticker}</span>`).join('')}
                            </div>
                            <div>${comment.body}</div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading comments:', error);
                document.getElementById('commentsContainer').innerHTML = 
                    '<div class="no-data">Error loading comments</div>';
            }
        }

        function refreshDashboard() {
            loadSubredditData();
            loadTickerData();
            loadComments();
        }

        // Initialize dashboard
        window.onload = function() {
            initCharts();
            refreshDashboard();
            
            // Auto-refresh every 30 seconds
            setInterval(refreshDashboard, 30000);
        };
    </script>
</body>
</html>